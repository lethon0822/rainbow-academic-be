<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rainbowuniv.academicmenagmentbe.account.AccountMapper">
    <!--    로그인 하기     -->

    <select id="findByLoginId">
        <![CDATA[
          SELECT
              u.user_id     AS userId,
              u.user_role   AS userRole,
              u.user_name   AS userName,
              u.login_id    AS loginId,
              COALESCE(ds.dept_name, dp.dept_name) AS deptName,
              COALESCE(ds.dept_id, dp.dept_id)     AS deptId,
              COALESCE(ds.dept_code, dp.dept_code) AS deptCode,
              (
                SELECT s.semester_id
                FROM semester s
                WHERE s.`year` = YEAR(NOW())
                  AND s.`semester` = CASE WHEN MONTH(NOW()) <= 6 THEN 1 ELSE 2 END
                LIMIT 1
              ) AS semesterId,
              u.password AS password
          FROM `user` u
            LEFT JOIN student    st ON st.user_id = u.user_id
            LEFT JOIN department ds ON ds.dept_id = st.dept_id
            LEFT JOIN professor  pf ON pf.user_id = u.user_id
            LEFT JOIN department dp ON dp.dept_id = pf.dept_id
          WHERE u.login_id = #{loginId}
            AND u.password = #{password}
          LIMIT 1
        ]]>
    </select>


    <!--   아이디 찾기    -->
    <select id="findIdByEmailAndPhone">
        SELECT user_name, login_id
        FROM user
        WHERE email = #{email}
        AND phone = #{phone}
    </select>
    <!--    이름가져오기    -->
    <select id="findNameByLoginId">
        SELECT user_name
        FROM user
        WHERE login_id = #{loginId}
    </select>

    <!-- 학과코드 가져오기 -->
    <select id="findDeptCodeByUserId">
        SELECT d.dept_id, d.dept_code, d.dept_name
        FROM student s
        JOIN department d ON s.dept_id = d.dept_id
        WHERE s.user_id = #{userId}

        UNION

        SELECT d.dept_id, d.dept_code, d.dept_name
        FROM professor p
        JOIN department d ON p.dept_id = d.dept_id
        WHERE p.user_id = #{userId};
    </select>

</mapper>