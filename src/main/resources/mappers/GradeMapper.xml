<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rainbowuniv.academicmenagmentbe.grade.GradeMapper">

    <!-- [2] Select Grades by Course -->
    <select id="gradesbyCourse">
        SELECT
        s.grade,
        c.semester,
        c.course_code,
        c.course_id,
        c.title,
        c.credit,
        e.rank,
        c.type
        FROM enrollment e
        JOIN course c ON e.course_id = c.course_id
        JOIN student s ON e.user_id = s.user_id
        WHERE e.user_id = #{userId}
        <if test="courseId != -1">
            AND c.course_id = #{courseId}
        </if>
        <if test="semester != -1">
            AND c.semester = #{semester}
        </if>
    </select>


    <!-- [3] Select Credit by Category -->
    <select id="selectCreditByCategory">
        SELECT
        s.grade AS grade,
        c.semester AS semester,
        SUM(CASE WHEN c.type = '전공필수' THEN c.credit ELSE 0 END) AS majorRequired,
        SUM(CASE WHEN c.type = '전공선택' THEN c.credit ELSE 0 END) AS majorElective,
        SUM(CASE WHEN c.type = '교양' THEN c.credit ELSE 0 END) AS generalEducation
        FROM enrollment e
        JOIN course c ON e.course_id = c.course_id
        JOIN student s ON e.user_id = s.user_id
        WHERE e.user_id = #{userId}
        <if test="courseId != -1">
            AND c.course_id = #{courseId}
        </if>
        <if test="semester != -1">
            AND c.semester = #{semester}
        </if>
        GROUP BY s.grade, c.semester
        ORDER BY s.grade, c.semester
    </select>

    <!-- [4] Select Semester Grades -->
    <select id="selectSemesterGradesByUser" parameterType="map" resultType="com.rainbowuniv.academicmenagmentbe.grade.model.SemesterGradeDTO">
        SELECT
        s.grade AS grade,
        c.semester AS semester,
        SUM(c.credit) AS requestedCredits,
        SUM(CASE WHEN e.score >= 60 THEN c.credit ELSE 0 END) AS acquiredCredits,
        AVG(e.score) AS avgScore,
        AVG(e.score / 20.0) AS avgGradePoint,
        MIN(e.rank) AS grading,
        COUNT(*) AS totalStudents
        FROM enrollment e
        JOIN course c ON e.course_id = c.course_id
        JOIN student s ON e.user_id = s.user_id
        WHERE e.user_id = #{userId}
        <if test="courseId != -1">
            AND c.course_id = #{courseId}
        </if>
        <if test="semester != -1">
            AND c.semester = #{semester}
        </if>
        GROUP BY s.grade, c.semester
        ORDER BY s.grade, c.semester
    </select>

    <!-- 영구 성적 조회 -->
    <select id="getMyAllGrades">
        SELECT
        se.year,
        se.semester,
        c.type,
        c.grade,
        u.user_name AS professorName,
        c.course_code,
        c.title,
        c.credit,
        s.rank

        FROM enrollment e
        JOIN course c
        ON e.course_id = c.course_id
        JOIN score s
        ON e.enrollment_id = s.enrollment_id
        JOIN semester se
        ON se.semester_id = c.semester_id
        JOIN user u
        ON u.user_id = c.user_id

        WHERE e.user_id = #{userId}
        <!-- 금학기 성적 조회 막는 부분. 프론트에서도 금학기는 필터에 안 뜨게 막아야 함. -->
        AND NOT (se.year = #{currentYear} AND se.semester = #{currentSemester})

        <if test="year != null">
            AND se.year = #{year}
        </if>

        <if test="semester != null">
            AND se.semester = #{semester}
        </if>

        <if test="type != null">
            AND c.type = #{type}
        </if>

        <if test="grade != null">
            AND c.grade = #{grade}
        </if>

        <if test="keyword != null and Keyword != ''">
            AND c.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>


</mapper>
