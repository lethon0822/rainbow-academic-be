<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rainbowuniv.academicmenagmentbe.staff.member.MemberMapper">

    <!-- MemberGetReq 의 필드명이 userRole, deptId, status, grade, gender, searchBy, q 라고 가정 -->
    <select id="findUser">

        <choose>

            <!-- 학생 -->
            <when test="userRole == 'student'">
                SELECT
                u.login_id   AS loginId,
                u.user_name  AS username,
                u.address    AS address,
                u.email      AS email,
                u.phone      AS phone,
                d.dept_name  AS deptName,
                s.grade      AS grade,
                s.status     AS status
                FROM `user` u
                JOIN student s        ON s.user_id = u.user_id
                LEFT JOIN department d ON d.dept_id = s.dept_id
                <where>
                    u.user_id &gt; 1
                    <if test="deptId != null">AND s.dept_id = #{deptId}</if>
                    <if test="grade != null"> AND s.grade  = #{grade}</if>
                    <if test="status != null and status != ''">AND s.status = #{status}</if>
                    <if test="gender != null and gender != ''">AND u.gender = #{gender}</if>
                    <if test="q != null and q != ''">
                        <choose>
                            <when test="searchBy == 'name'">    AND u.user_name LIKE CONCAT('%', #{q}, '%')</when>
                            <when test="searchBy == 'loginId'"> AND u.login_id  LIKE CONCAT('%', #{q}, '%')</when>
                            <when test="searchBy == 'email'">   AND u.email     LIKE CONCAT('%', #{q}, '%')</when>
                            <otherwise>
                                AND ( u.user_name LIKE CONCAT('%', #{q}, '%')
                                OR u.login_id  LIKE CONCAT('%', #{q}, '%')
                                OR u.email     LIKE CONCAT('%', #{q}, '%') )
                            </otherwise>
                        </choose>
                    </if>
                </where>
                ORDER BY u.user_id DESC
            </when>

            <!-- 교수 (기본) -->
            <otherwise>
                SELECT
                u.login_id   AS loginId,
                u.user_name  AS username,
                u.address    AS address,
                u.email      AS email,
                u.phone      AS phone,
                d.dept_name  AS deptName,
                p.status     AS status
                FROM `user` u
                JOIN professor p        ON p.user_id = u.user_id
                LEFT JOIN department d  ON d.dept_id = p.dept_id
                <where>
                    u.user_id &gt; 1
                    <if test="deptId != null">AND p.dept_id = #{deptId}</if>
                    <if test="status != null and status != ''">AND p.status = #{status}</if>
                    <if test="gender != null and gender != ''">AND u.gender = #{gender}</if>
                    <if test="q != null and q != ''">
                        <choose>
                            <when test="searchBy == 'name'">    AND u.user_name LIKE CONCAT('%', #{q}, '%')</when>
                            <when test="searchBy == 'loginId'"> AND u.login_id  LIKE CONCAT('%', #{q}, '%')</when>
                            <when test="searchBy == 'email'">   AND u.email     LIKE CONCAT('%', #{q}, '%')</when>
                            <otherwise>
                                AND ( u.user_name LIKE CONCAT('%', #{q}, '%')
                                OR u.login_id  LIKE CONCAT('%', #{q}, '%')
                                OR u.email     LIKE CONCAT('%', #{q}, '%') )
                            </otherwise>
                        </choose>
                    </if>
                </where>
                ORDER BY u.user_id DESC
            </otherwise>

        </choose>
    </select>
</mapper>
