<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rainbowuniv.academicmenagmentbe.staff.department.DepartmentMapper">

    <insert id="save">
        INSERT INTO department
        SET dept_name = #{deptName},
            dept_office = #{deptOffice},
            dept_tel = #{deptTel},
            dept_max_std = #{deptMaxStd},
            dept_code = #{deptCode}
    </insert>

<!-- 학과 조회-->
    <select id="findAll">
        SELECT d.*, s.deptPeople, u.user_name
        FROM department d
        JOIN (
        SELECT dept_id, COUNT(user_id) AS deptPeople
        FROM student
        WHERE status != '졸업'
        GROUP BY dept_id
        ) s ON d.dept_id = s.dept_id
        JOIN professor p ON d.dept_id = p.dept_id
        JOIN user u ON u.user_id = p.user_id
        WHERE u.user_id = d.head_prof_id
        <if test="status != null and status != ''">
            AND d.`status` = #{status}
        </if>
        <if test="status != null and status != ''">
            AND d.dept_code LIKE '%${text}%' OR d.dept_name LIKE '%${text}%'
        </if>
    </select>

    <update id="modifyDepartment">
        UPDATE department
        SET
        dept_name = #{deptName},
        dept_office = #{deptOffice},
        dept_tel = #{deptTel},
        dept_max_std = #{deptMaxStd},
        dept_code = #{deptCode}
        <if test="headProfId !=null and headProfId != ''">
            ,head_prof_id = #{headProfId}
        </if>
        WHERE dept_id = #{deptId}
    </update>

<!-- 학과 상태만 수정-->
    <update id="modifyStatus">
        UPDATE department
        SET status = #{status}
        WHERE dept_id = #{deptId}
    </update>
</mapper>